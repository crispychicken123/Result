<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crispy Chicken ‚Äì Sales Comparison System Pro</title>
<!-- SheetJS for Excel handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #d32f2f; /* Crispy Red */
    --primary-dark: #b71c1c;
    --secondary: #fbc02d; /* Crispy Yellow/Gold */
    --bg: #f4f6f8;
    --surface: #ffffff;
    --text-main: #2c3e50;
    --text-light: #607d8b;
    --border: #e0e0e0;
    --success: #2e7d32;
    --danger: #c62828;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text-main);
    margin: 0;
    padding: 20px;
  }

  /* Layout */
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    background: var(--surface);
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    border-top: 4px solid var(--primary);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand h1 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--primary);
  }

  .branch-selector select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 1rem;
    outline: none;
    background: #fff;
  }

  /* Grid System */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  @media (max-width: 768px) {
    .dashboard-grid { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--surface);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
  }

  .card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-main);
  }

  /* File Upload Zone */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafafa;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--primary);
    background: #fff0f0;
  }

  .upload-zone input[type="file"] {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .upload-icon {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
  }

  .file-status {
    margin-top: 10px;
    font-size: 0.9rem;
    font-weight: bold;
  }
  .status-ok { color: var(--success); }
  .status-pending { color: var(--text-light); }

  /* Action Buttons */
  .btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: var(--primary-dark); }
  .btn:disabled { background: #ccc; cursor: not-allowed; }
  
  .btn-outline {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
  }
  .btn-outline:hover { background: #fff0f0; }

  /* Stats Row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--surface);
    padding: 15px;
    border-radius: 10px;
    box-shadow: var(--shadow);
    text-align: center;
  }

  .stat-val { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
  .stat-label { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }

  /* Mapping Manager */
  .mapping-container {
    margin-top: 10px;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px;
    font-size: 0.85rem;
  }
  .mapping-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 8px;
    border-bottom: 1px solid #eee;
  }
  .mapping-row:last-child { border-bottom: none; }
  .add-mapping {
    display: flex;
    gap: 5px;
    margin-top: 5px;
  }
  .add-mapping input {
    padding: 4px;
    border: 1px solid #ccc;
    border-radius: 4px;
    flex: 1;
  }

  /* Results Table */
  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }

  th {
    background: #f8f9fa;
    color: var(--text-main);
    font-weight: 600;
    text-align: left;
    padding: 12px 16px;
    border-bottom: 2px solid var(--border);
  }

  td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  tr:hover { background-color: #f1f1f1; }

  .badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
  }
  .bg-pos { background-color: #e8f5e9; color: var(--success); }
  .bg-neg { background-color: #ffebee; color: var(--danger); }
  .bg-neu { background-color: #f5f5f5; color: var(--text-light); }

  /* Toast Notification */
  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    padding: 12px;
    position: fixed;
    z-index: 100;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 14px;
  }
  #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

  @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
  @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

</style>
</head>
<body>

<div class="container">
  <header>
    <div class="brand">
      <span style="font-size: 24px;">üçó</span>
      <div>
        <h1>Crispy Chicken System</h1>
        <span style="font-size: 0.85rem; color: var(--text-light);">Sales Reconciliation & Comparison</span>
      </div>
    </div>
    <div class="branch-selector">
      <label style="font-weight: 600; margin-right: 8px;">Branch:</label>
      <select id="branch">
        <option>Crispy Chicken-Hamdan St</option>
        <option>Crispy Chicken Khaldia</option>
        <option>Crispy Chicken Shabiya 11</option>
        <option>Crispy Chicken Muroor</option>
        <option>Crispy Chicken Al Electra</option>
        <option>Crispy Chicken Al Barsha</option>
        <option>Crispy Chicken Al Satwa</option>
        <option>Crispy Chicken Al Rigga</option>
        <option>Crispy Chicken Al Majaz</option>
      </select>
    </div>
  </header>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Total POS Sales</div>
      <div class="stat-val" id="totalPos">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Platform Sales</div>
      <div class="stat-val" id="totalPlat">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Variance</div>
      <div class="stat-val" id="totalDiff" style="color: var(--text-main)">0</div>
    </div>
  </div>

  <div class="dashboard-grid">
    <!-- Left Column: Inputs -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
      
      <!-- POS Upload -->
      <div class="card">
        <div class="card-header">
          <h3>1. POS System Data</h3>
        </div>
        <div class="upload-zone" id="zonePos">
          <span class="upload-icon">üñ•Ô∏è</span>
          <div><strong>Click to Upload</strong> or Drag & Drop</div>
          <div style="font-size: 0.8rem; color: #999;">Excel (.xlsx, .xls)</div>
          <input type="file" id="posFile" accept=".xlsx, .xls">
          <div class="file-status" id="statusPos">No file selected</div>
        </div>
      </div>

      <!-- Platform Upload -->
      <div class="card">
        <div class="card-header">
          <h3>2. Platform Data (Delivery Apps)</h3>
        </div>
        <div class="upload-zone" id="zonePlat">
          <span class="upload-icon">üì±</span>
          <div><strong>Click to Upload</strong> or Drag & Drop</div>
          <div style="font-size: 0.8rem; color: #999;">Excel (.xlsx, .xls)</div>
          <input type="file" id="platFile" accept=".xlsx, .xls">
          <div class="file-status" id="statusPlat">No file selected</div>
        </div>
      </div>

      <!-- Mapping Manager -->
      <div class="card">
        <div class="card-header">
          <h3>‚öôÔ∏è Recipe Name Mapping</h3>
          <button class="btn btn-outline" style="font-size: 0.75rem; padding: 4px 8px;" onclick="resetMappings()">Reset</button>
        </div>
        <p style="font-size: 0.85rem; color: #666; margin-top:0;">
          If names differ (e.g., "Daily Spicy" vs "Daily Spicy Meal"), add a rule to normalize them.
        </p>
        <div class="mapping-container" id="mappingList">
          <!-- Items injected by JS -->
        </div>
        <div class="add-mapping">
          <input type="text" id="mapSource" placeholder="Raw Name (e.g. spicy noon)">
          <input type="text" id="mapTarget" placeholder="Target Name (e.g. Daily Spicy Meal)">
          <button class="btn" onclick="addMapping()" style="padding: 4px 12px; font-size: 0.8rem;">+</button>
        </div>
      </div>

      <button class="btn" id="processBtn" onclick="processFiles()" style="width: 100%; justify-content: center; padding: 14px;">
        üîç Run Comparison
      </button>
    </div>

    <!-- Right Column: Results -->
    <div class="card" style="height: 100%;">
      <div class="card-header">
        <h3>Comparison Results</h3>
        <button class="btn btn-outline" id="exportBtn" onclick="exportToExcel()" disabled>
          üì• Export Excel
        </button>
      </div>
      
      <div class="table-container">
        <table id="resultTable">
          <thead>
            <tr>
              <th>Recipe</th>
              <th style="text-align:center;">POS Qty</th>
              <th style="text-align:center;">Plat Qty</th>
              <th style="text-align:center;">Diff</th>
              <th style="text-align:center;">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="5" style="text-align:center; padding: 30px; color: #999;">
                Upload files and click "Run Comparison" to see results.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast">Message here</div>

<script>
// --- Configuration & State ---
let posDataArray = [];
let platDataArray = [];
let processedResults = [];

// Default Mappings
let recipeMap = {
  "daily spicy meal": "Daily Spicy Meal",
  "daily spicy meal noon": "Daily Spicy Meal",
  "daily offer spicy meal": "Daily Spicy Meal",
  "daily original meal": "Daily Original Meal",
  "daily original meal noon": "Daily Original Meal",
  "daily offer original meal": "Daily Original Meal",
  "ultimate spicy": "Ultimate Spicy",
  "ultimate s noon offers": "Ultimate Spicy",
  "ultimate original": "Ultimate Original",
  "ultimate o noon offers": "Ultimate Original"
};

// --- UI Interactions ---

// Toast Helper
function showToast(msg) {
  const x = document.getElementById("toast");
  x.textContent = msg;
  x.className = "show";
  setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
}

// File Drag & Drop Visuals
['zonePos', 'zonePlat'].forEach(id => {
  const zone = document.getElementById(id);
  const input = zone.querySelector('input');
  const status = zone.nextElementSibling ? zone.querySelector('.file-status') : document.getElementById(id === 'zonePos' ? 'statusPos' : 'statusPlat');

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('dragover');
  });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      input.files = e.dataTransfer.files;
      handleFileSelect(input, status);
    }
  });
  input.addEventListener('change', () => handleFileSelect(input, status));
});

function handleFileSelect(input, statusElem) {
  if (input.files.length > 0) {
    statusElem.textContent = "‚úÖ " + input.files[0].name;
    statusElem.classList.add('status-ok');
    statusElem.classList.remove('status-pending');
  } else {
    statusElem.textContent = "No file selected";
  }
}

// --- Mapping Logic ---

function renderMappings() {
  const container = document.getElementById('mappingList');
  container.innerHTML = '';
  Object.keys(recipeMap).forEach(key => {
    const row = document.createElement('div');
    row.className = 'mapping-row';
    row.innerHTML = `
      <span>${key}</span>
      <span>‚ûú</span>
      <strong>${recipeMap[key]}</strong>
      <span style="color:red; cursor:pointer; margin-left:auto;" onclick="removeMapping('${key}')">√ó</span>
    `;
    container.appendChild(row);
  });
}

function addMapping() {
  const src = document.getElementById('mapSource').value.toLowerCase().trim();
  const tgt = document.getElementById('mapTarget').value.trim();
  
  if (!src || !tgt) {
    showToast("Please enter both names.");
    return;
  }
  
  recipeMap[src] = tgt;
  renderMappings();
  document.getElementById('mapSource').value = '';
  document.getElementById('mapTarget').value = '';
}

function removeMapping(key) {
  delete recipeMap[key];
  renderMappings();
}

function resetMappings() {
  if(confirm("Reset all custom mappings to default?")) {
    // Re-apply defaults (simplified for this demo)
    location.reload(); 
  }
}

// Normalize name using Map
function normalize(name) {
  if (!name) return "Unknown Item";
  let clean = name.toString().toLowerCase().trim();
  return recipeMap[clean] || name; // Return mapped name or original
}

// --- Excel Processing ---

function getColKeys(row) {
  // Attempt to find column index for 'Name/Item' and 'Qty'
  const keys = Object.keys(row);
  let nameKey = keys.find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('item'));
  let qtyKey = keys.find(k => k.toLowerCase().includes('qty') || k.toLowerCase().includes('sold') || k.toLowerCase().includes('quantity'));
  
  return { nameKey, qtyKey, keys };
}

function readExcel(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: "binary" });
        const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        resolve(sheet);
      } catch (err) {
        reject(err);
      }
    };
    reader.readAsBinaryString(file);
  });
}

async function processFiles() {
  const posFile = document.getElementById('posFile').files[0];
  const platFile = document.getElementById('platFile').files[0];
  const btn = document.getElementById('processBtn');

  if (!posFile || !platFile) {
    showToast("Please upload both POS and Platform files.");
    return;
  }

  btn.disabled = true;
  btn.innerHTML = "‚è≥ Processing...";

  try {
    // 1. Read Data
    const posRaw = await readExcel(posFile);
    const platRaw = await readExcel(platFile);

    if (posRaw.length === 0 || platRaw.length === 0) throw new Error("One of the files appears empty.");

    // 2. Identify Columns automatically from the first row
    const posCols = getColKeys(posRaw[0]);
    const platCols = getColKeys(platRaw[0]);

    if (!posCols.nameKey || !posCols.qtyKey) throw new Error("Could not detect Name/Qty columns in POS file.");
    if (!platCols.nameKey || !platCols.qtyKey) throw new Error("Could not detect Name/Qty columns in Platform file.");

    // 3. Aggregate Data
    const posAgg = {};
    const platAgg = {};

    posRaw.forEach(r => {
      const name = normalize(r[posCols.nameKey]);
      const qty = Number(r[posCols.qtyKey]) || 0;
      posAgg[name] = (posAgg[name] || 0) + qty;
    });

    platRaw.forEach(r => {
      const name = normalize(r[platCols.nameKey]);
      const qty = Number(r[platCols.qtyKey]) || 0;
      platAgg[name] = (platAgg[name] || 0) + qty;
    });

    // 4. Compare
    processedResults = [];
    const allKeys = new Set([...Object.keys(posAgg), ...Object.keys(platAgg)]);

    allKeys.forEach(key => {
      const p = posAgg[key] || 0;
      const pl = platAgg[key] || 0;
      const diff = p - pl;
      processedResults.push({
        recipe: key,
        posQty: p,
        platQty: pl,
        diff: diff
      });
    });

    // 5. Render
    renderDashboard();
    document.getElementById('exportBtn').disabled = false;
    showToast("Comparison Complete!");

  } catch (err) {
    console.error(err);
    showToast("Error: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = "üîç Run Comparison";
  }
}

function renderDashboard() {
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  let totalPos = 0;
  let totalPlat = 0;

  // Sort by Absolute Variance (highest first) for better visibility
  processedResults.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));

  processedResults.forEach(row => {
    totalPos += row.posQty;
    totalPlat += row.platQty;

    let statusClass = "bg-neu";
    let statusText = "Match";
    
    if (row.diff > 0) {
      statusClass = "bg-pos";
      statusText = "Extra POS";
    } else if (row.diff < 0) {
      statusClass = "bg-neg";
      statusText = "Missing";
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.recipe}</td>
      <td style="text-align:center;">${row.posQty}</td>
      <td style="text-align:center;">${row.platQty}</td>
      <td style="text-align:center; font-weight:bold;">${row.diff > 0 ? '+' : ''}${row.diff}</td>
      <td style="text-align:center;"><span class="badge ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(tr);
  });

  // Update Stats
  document.getElementById("totalPos").textContent = totalPos;
  document.getElementById("totalPlat").textContent = totalPlat;
  
  const totalDiff = totalPos - totalPlat;
  const diffElem = document.getElementById("totalDiff");
  diffElem.textContent = (totalDiff > 0 ? "+" : "") + totalDiff;
  diffElem.style.color = totalDiff === 0 ? "var(--text-main)" : (totalDiff > 0 ? "var(--success)" : "var(--danger)");
}

// --- Export Function ---

function exportToExcel() {
  if (processedResults.length === 0) return;

  // Create a worksheet from the data
  const ws = XLSX.utils.json_to_sheet(processedResults.map(r => ({
    Recipe: r.recipe,
    POS_Qty: r.posQty,
    Platform_Qty: r.platQty,
    Variance: r.diff
  })));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Comparison");

  const branchName = document.getElementById("branch").value.replace(/\s+/g, '_');
  const date = new Date().toISOString().slice(0,10);
  
  XLSX.writeFile(wb, `Crispy_Chicken_Report_${branchName}_${date}.xlsx`);
}

// Initialize Mappings on Load
renderMappings();

</script>

</body>
</html>
