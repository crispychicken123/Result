<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Reconciliation (Ultimate Edition - FIXED)</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (Excel Reader) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            margin: 0; padding: 0; 
            color: var(--text-main); 
            line-height: 1.5;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        /* --- Components --- */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
        }

        /* --- Header --- */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 30px; 
        }
        .header-title h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); }
        .header-title span { font-size: 14px; color: var(--text-muted); font-weight: 500; }
        
        /* Branch Selector */
        .branch-selector { display: flex; align-items: center; gap: 12px; background: white; padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .branch-selector select { 
            border: none; font-size: 15px; font-weight: 600; color: var(--primary-dark); 
            background: transparent; outline: none; cursor: pointer; 
        }

        /* --- KPI Area --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; }
        .kpi-card.blue { border-left: 4px solid var(--primary); }
        .kpi-card.green { border-left: 4px solid var(--success); }
        .kpi-card.red { border-left: 4px solid var(--danger); }
        .kpi-card.orange { border-left: 4px solid var(--warning); }
        
        .kpi-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; }
        .kpi-value { font-size: 28px; font-weight: 700; margin: 8px 0; color: var(--text-main); }
        .kpi-sub { font-size: 12px; color: var(--text-muted); }

        /* --- Charts Section --- */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        /* --- Action Bar --- */
        .actions { display: flex; gap: 12px; margin-bottom: 20px; }
        .btn { 
            padding: 10px 16px; border-radius: 8px; font-weight: 500; font-size: 14px; 
            cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; 
            transition: all 0.2s; 
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f8fafc; border-color: #cbd5e1; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }

        /* --- Matrix --- */
        .matrix-table { width: 100%; border-collapse: collapse; }
        .matrix-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        .matrix-table td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .matrix-row { cursor: pointer; transition: background 0.15s; }
        .matrix-row:hover { background-color: #f1f5f9; }
        .matrix-row.active { background-color: #eff6ff; border-left: 3px solid var(--primary); }

        /* --- Main Table --- */
        .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th { 
            background: #f8fafc; color: var(--text-muted); font-weight: 600; text-align: left; padding: 12px 16px; 
            border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 10; 
        }
        tbody td { padding: 10px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tbody tr:hover { background-color: #f8fafc; }
        
        .editable-cell { 
            background: #fff; border: 1px solid transparent; border-radius: 4px; padding: 4px 8px; 
            font-family: 'Menlo', 'Monaco', monospace; font-weight: 600; color: var(--text-main); 
            cursor: text; min-width: 60px; text-align: center; display: inline-block;
        }
        .editable-cell:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .editable-cell:hover { border-color: #cbd5e1; }

        .diff-pos { color: var(--success); font-weight: 700; }
        .diff-neg { color: var(--danger); font-weight: 700; }
        .diff-zero { color: var(--secondary); font-weight: 600; }

        /* --- Config / Inputs --- */
        .config-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .input-section { margin-bottom: 20px; }
        .input-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-header h3 { margin: 0; font-size: 16px; color: var(--text-main); }
        
        .file-drop { border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc; transition: border 0.2s; position: relative; }
        .file-drop:hover { border-color: var(--primary); background: #eff6ff; }
        .file-drop input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        textarea { 
            width: 100%; height: 80px; border: 1px solid var(--border); border-radius: 6px; 
            padding: 10px; font-family: monospace; font-size: 12px; resize: vertical; 
            margin-top: 10px; background: #fff; box-sizing: border-box;
        }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: white; width: 800px; border-radius: 12px; padding: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Utilities --- */
        .search-bar { width: 300px; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #475569; font-weight: 600; }

        @media print {
            .actions, .config-section, .file-drop, .btn, .branch-selector, .charts-section { display: none !important; }
            body, .container { background: white; max-width: 100%; margin: 0; padding: 0; }
            .card { box-shadow: none; border: none; padding: 0; margin: 0; }
            table { border: 1px solid #ccc; }
            th, td { border: 1px solid #ccc; }
            .editable-cell { border: none; }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- HEADER -->
    <header>
        <div class="header-title">
            <h1>Enterprise Reconciliation</h1>
            <span>Stock & Sales Variance Tool with Analytics</span>
        </div>
        
        <div class="branch-selector">
            <label for="branchSelect" style="font-size:14px; color:var(--text-muted); font-weight:600;">Branch:</label>
            <select id="branchSelect" class="branch-select" onchange="switchBranch()">
                <option value="">-- Select Branch --</option>
                <option value="Hamdan St">Crispy Chicken Hamdan St</option>
                <option value="Khaldia">Crispy Chicken Khaldia</option>
                <option value="Shabiya 11">Crispy Chicken Shabiya 11</option>
                <option value="Muroor">Crispy Chicken Muroor</option>
                <option value="Al Electra">Crispy Chicken Al Electra</option>
                <option value="Al Barsha">Crispy Chicken Al Barsha</option>
                <option value="Al Satwa">Crispy Chicken Al Satwa</option>
                <option value="Al Rigga">Crispy Chicken Al Rigga</option>
                <option value="Al Majaz">Crispy Chicken Al Majaz</option>
            </select>
        </div>
    </header>

    <!-- KPI CARDS -->
    <div class="kpi-grid">
        <div class="kpi-card blue">
            <div class="kpi-label">Total REST</div>
            <div class="kpi-value" id="kpi-rest">0</div>
            <div class="kpi-sub">Stock Count Volume</div>
        </div>
        <div class="kpi-card green">
            <div class="kpi-label">Total POS</div>
            <div class="kpi-value" id="kpi-pos">0</div>
            <div class="kpi-sub">System Sales Volume</div>
        </div>
        <div class="kpi-card red">
            <div class="kpi-label">Net Variance</div>
            <div class="kpi-value diff-zero" id="kpi-diff">0</div>
            <div class="kpi-sub">Difference (POS - REST)</div>
        </div>
        <div class="kpi-card orange">
            <div class="kpi-label">Accuracy</div>
            <div class="kpi-value" id="kpi-acc">100%</div>
            <div class="kpi-sub">Volume Match Rate</div>
        </div>
    </div>

    <!-- NEW: CHARTS SECTION -->
    <div class="card charts-section">
        <div class="charts-grid">
            <!-- Chart 1: Volume Comparison -->
            <div>
                <h3 style="margin-top:0; font-size:16px; color:var(--text-muted);">Volume Comparison (REST vs POS)</h3>
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
            <!-- Chart 2: Top 10 Variances -->
            <div>
                <h3 style="margin-top:0; font-size:16px; color:var(--text-muted);">Top 10 Item Variances (Absolute)</h3>
                <div class="chart-container">
                    <canvas id="varianceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- COMPARISON MATRIX -->
    <div class="card" style="padding: 15px 24px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:16px;">üìä Branch Comparison Matrix</h3>
            <span style="font-size:12px; color:var(--text-muted);">Click a row to load data</span>
        </div>
        <table class="matrix-table">
            <thead>
                <tr>
                    <th>Branch</th>
                    <th>Items</th>
                    <th>Total REST</th>
                    <th>Total POS</th>
                    <th>Variance</th>
                    <th>Accuracy</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="matrixBody">
                <!-- Injected via JS -->
            </tbody>
        </table>
    </div>

    <!-- MAIN TABLE SECTION -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-size:18px;">Item Reconciliation</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="searchInput" class="search-bar" placeholder="Search items...">
                <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Print</button>
                <button class="btn btn-primary" onclick="generateReport()">üìÑ Report</button>
                <button class="btn btn-success" onclick="addToMatrix()">üíæ Save to Matrix</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40%">Item Name</th>
                        <th style="width: 15%; text-align:center">Qty REST</th>
                        <th style="width: 15%; text-align:center">Qty POS</th>
                        <th style="width: 15%; text-align:center">Diff</th>
                        <th style="width: 15%; text-align:center">Var %</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- INPUT CONFIGURATION SECTION -->
    <div class="card config-section">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:10px;">Data Configuration</h3>
        
        <!-- Master Data -->
        <div class="input-section">
            <div class="input-header">
                <h3>üìò 1. Standard Item List (Master Data)</h3>
                <button class="btn btn-warning" onclick="loadProvidedList()" style="font-size:12px; padding:6px 12px;">Load Clean List</button>
            </div>
            <div class="file-drop">
                <span class="tag">Upload Excel</span>
                <input type="file" accept=".xlsx, .xls" onchange="uploadExcel(this, 'master')">
                <span style="font-size:12px; color:var(--text-muted);">Drop Master List File Here</span>
            </div>
            <textarea id="inputMASTER" placeholder="Paste Master Item List (One item per line)..."></textarea>
        </div>

        <!-- Sales Data -->
        <div class="input-section">
            <div class="input-header">
                <h3>üìÇ 2. Sales Data (REST & POS)</h3>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <label style="font-weight:600; font-size:12px; display:block; margin-bottom:5px;">Platform (REST)</label>
                    <div class="file-drop">
                        <span class="tag">Upload Excel</span>
                        <input type="file" accept=".xlsx, .xls" onchange="uploadExcel(this, 'rest')">
                        <span style="font-size:12px; color:var(--text-muted);">Drop REST File</span>
                    </div>
                    <textarea id="inputREST" placeholder="Paste REST Data (Name | Qty)..."></textarea>
                </div>
                <div>
                    <label style="font-weight:600; font-size:12px; display:block; margin-bottom:5px;">POS (Cashier)</label>
                    <div class="file-drop">
                        <span class="tag">Upload Excel</span>
                        <input type="file" accept=".xlsx, .xls" onchange="uploadExcel(this, 'pos')">
                        <span style="font-size:12px; color:var(--text-muted);">Drop POS File</span>
                    </div>
                    <textarea id="inputPOS" placeholder="Paste POS Data (Name | Qty)..."></textarea>
                </div>
            </div>
            <button class="btn btn-primary" onclick="processData()" style="margin-top:15px; width:100%; justify-content:center;">Process & Calculate</button>
        </div>
    </div>

</div>

<!-- REPORT MODAL -->
<div id="reportModal" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0; color:var(--primary-dark);">Reconciliation Summary</h2>
        <p id="reportMeta" style="color:var(--text-muted); margin-bottom:20px;">Branch: ... | Date: ...</p>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
            <div style="background:#f1f5f9; padding:15px; border-radius:8px;">
                <div style="font-size:12px; color:var(--text-muted); font-weight:600;">VARIANCE COUNT</div>
                <div id="rptVariance" style="font-size:24px; font-weight:700; color:var(--danger);">0</div>
            </div>
            <div style="background:#f1f5f9; padding:15px; border-radius:8px;">
                <div style="font-size:12px; color:var(--text-muted); font-weight:600;">MATCHED ITEMS</div>
                <div id="rptMatched" style="font-size:24px; font-weight:700; color:var(--success);">0</div>
            </div>
        </div>
        
        <!-- Variance Table -->
        <div style="border-top: 1px solid #e2e8f0; margin-top: 15px; padding-top: 15px;">
            <h3 style="font-size:16px; margin: 0 0 10px 0;">üìã Item Variance Details</h3>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px;">
                <table class="matrix-table" style="font-size:12px;">
                    <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 5;">
                        <tr>
                            <th>Item Name</th>
                            <th style="text-align:center">REST</th>
                            <th style="text-align:center">POS</th>
                            <th style="text-align:center">Diff</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>
        </div>

        <div style="text-align:right; margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
            <button class="btn btn-outline" onclick="closeReport()" style="float:left;">Close</button>
            <button class="btn btn-warning" onclick="downloadReportCSV()">‚¨áÔ∏è Download Excel/CSV</button>
            <button class="btn btn-success" onclick="copyReport()">Copy Text</button>
        </div>
    </div>
</div>

<script>
// --- 1. DATA CONSTANTS ---
const PROVIDED_MASTER_DATA = `Item 
ULTIMATE  Spicy
Daily Spicy Meal
Daily Original Meal
Daily Spicy Meal Noon
Ultimate S Noon Offers
DAILY OFFER Original Meal
SUPER  MEAL  Original
DAILY OFFER Spicy Meal
Daily MIX Meal Noon
Daily MIX Meal
SAVING MEAL Original
SUPER MEAL  Spicy
Daily Original Meal Noon
SUPER MEAL - MIX
RICE MEAL Original
SAVING MEAL Spicy
DAILY OFFER MIX Meal
TWIN BEEF BURGER
ULTIMATE Original
BUCKET MEAL Spicy
BEEF BURGER SANDWICH
IDEAL MEAL  Original
RICE MEAL Spicy
WHITE RICE
MEGA MEAL Original
IDEAL MEAL  Spicy
BUCKET MEAL Original
GRAVY SAUCE
BUCKET MEAL MIX
SPICIAL FAMILY Original
PEPSI S
SNACK SANDWICH Spicy
IDEAL MEAL MIX
FRENCH FRIES SMALL
LITER PEPSI
1/2  CHICKEN  Original
CHICKEN STRIPS Original Meal
TWIST Origina SANDWICHES
SNACK SANDWICH Original
TWIST Spicy SANDWICHES
DELIVERY CHARGES 5
SPICIAL FAMILY MIX
MEGA MEAL  Spicy
SHAWARMA Origina SANDWICHES
SUPER CRUNCHY SP SANDWICHES
FRENCH FRIES LARGE
HOT CHEDAR CHEESE
SNACK BOX Spicy
Twin Twist Original
Crispy Strips Spicy Meal
Big Coleslaw
Twin Twist Spicy
SUPER CRUNCHY OR SANDWICHES
SNACK BOX Original
FAJITA SANDWICHES
SPICED RICE
1/2  CHICKEN  Spicy
FAJITA Spicy SANDWICHES
Twin Suprem Spicy
SPICIAL FAMILY Spicy
TORNADO Origina   SANDWICHES
Crispy Snack Spicy Meal
GARLIC - SMALL
FRENCH FRIES BOX
Small Coleslaw
DYNAMITE Origina  SANDWICHES
SUPREME Origina  SANDWICHES
Twin Chicken Burger
CRISPY RICE
CHICKEN BURGER SANDWICH
Steak Combo
CRISPY LARGE Original
MEGA MEAL MIX
ECONMY MEAL Original
M.WATER 500ML
SHAWARMA Spicy SANDWICHES
Volcano Sandwich Double
TWIN SHAWARMA MEAL
BUFFALO SANDWICH
Crispy Snack Original Meal
Volcano Combo Single
Twin Supreme Meal
Volcano Combo Double
Twin SUPREM MIX
STRIPS FAMILY  Original
Steak Sandwich
MAXI CHICKEN SINGLE COMBO
CHICKEN DAY Original
MAXI CHICKEN DOUBLE COMBO
LITER Mountain Dew
Volcano Sandwich Single
TORNADO Spicy SANDWICHES
SUPREME Spicy SANDWICHES
Mountain Dew S
SPICY PCS
12 PCS PACKET MIX
DYNAMITE SAUCE
KANZA
Spicy - FRIES
ECONMY MEAL Spicy
DYNAMITE Spicy SANDWICHES
MAX DOUBLE SANDWICH
BEEF BURGER COMBO
12 PCS PACKET Original
7UP S
MIRINDA S
BUN
20 PCS PACKET MIX
STRIPS FAMILY  Spicy
Twin Twist MIX
12 PCS PACKET Spicy
LITER MIRINDA
LITER 7UP
CRISPY LARGE Spicy
NORMAL PCS
FAJITA COMBO
SUPREM OR COMBO
CHICKEN DAY SPICY
20 PCS PACKET Spicy
FAJITA Spicy COMBO
TORNADO OR COMBO
**Spicy Fries**
SUPER CRUNCHY SP COMBO
SUPER CRUNCHY OR COMBO
TWIST OR COMBO
SUPREM SP COMBO
TWIST BOX  Original
TWIST BOX  SpICY
SMALL JUICE
TWIST SP COMBO
CRISPY SMALL Spicy
Ultimate O Noon Offers
Ultimate M Noon Offers
16 PCS PACKET Spicy
ECONMY MEAL MIX
DIET PEPSI S
TORNADO SP COMBO
UP CHARAGE
Upsize Large Fries And Large Pep
STRIPS FAMILY MIX
20 PCS PACKET Original
16 PCS PACKET Original
Extra Chesses
KIDS MEAL POP CORN
PKT STRIPS 20 MIX
QUICK NORMAL
QUICK SPICY
CRISPY SMALL  Original
KIDS MEAL NUGGETS
JUCE LAKNOR LARGE
CHICKEN BUEGER COMBO
GO KANZA .
Golden 4 meal Spicy
MAX SINGLE SANDWICH
DYNAMITE OR COMBO
DYNAMITE SPY COMBO
Cheese
BUFFALO MEAL
CHICKEN DAY MIX Noon
Golden 4 meal Normal
LARGE POP CORN
GO Family KANZA
6 PCS NUGGETS
Go Large
SMALL POP CORN
LARGE MIRINDA
LARGE  PEPSI
Extra BBQ
GO Shani
**Not Spicy Fries**
10 STRIPS OR 10 STRIPS SPY
12 SPICY 8 ORGINAL
16 SPICY 4 ORGINAL
1 CH OR 7 CH SP
2 CH OR 6 CH SP
2LITER 7UP Combo
2LITER PEPSI Combo
3 CH OR 5 CH SP
3 STRIPS OR 5 STRIPS SP
4 CH OR 4 CH SP
4 ORGINAL 12 SPICY
4 SPICY 12 ORGINAL
4 SPICY 8 ORGINAL
4 STRIPS OR 4 STRIPS SP
5 CH OR 3 CH SP
5 STRIPS OR 3 STRIPS SP
6 CH OR 2 CH SP
7 CH OR 1 CH SP
7 STRIPS OR 1 STRIPS SP
7 UP COMBO
8 SPICY 12 ORGINAL
8 SPICY 4 ORGINAL
8 SPICY 8 ORGINAL
CUT
DELIVERY CHARGES 7
DELIVERY CHARGES 9
DIET PEPSI COMBO
Extra Greenpaper
Extra Icebearge
Extra Jalapino
Extra Mayo
Extra Onion
Extra Pickles
Extra Sauce
Extra Tomato
GO WATER.
LITER 7UP Combo
LITER MIRINDA Combo
LITER PEPSI Combo
MIRANDA COMBO
Mountain Dew COMBO
NO BREAST
NO ICE
NO LEG
NO THIGH
NO WING
PEPSI COMBO
QUICK NORMAL Employees
QUICK Spicy Employees
QUICK Spicy Maintenance
Without BBQ
Without Chesses
Without Greenpaper
Without Icebearge
Without Jalapino
Without Mayo
Without Onion
Without Pickles
Without Sause
Without Terky
Without Tomato`;

// --- 2. GLOBAL STATE ---
const state = {
    masterData: [],
    restData: [],
    posData: [],
    results: [],
    currentBranch: "",
    matrix: [],
    
    // !!! CUSTOMIZE MAPPINGS HERE !!!
    // Add entries here if "REST" names do not match "Master/POS" names
    mapping: {
        "daily spicy meal noon": "Daily Spicy Meal",
        "daily spicy meal": "Daily Spicy Meal",
        "**spicy fries**": "Spicy - FRIES",
        "**not spicy fries**": "FRENCH FRIES SMALL",
        "extra chesses": "EXTRA CHEESE",
        // Add more: "bad name": "Good Name"
    }
};

// Global Chart Instances
let volumeChartInstance = null;
let varianceChartInstance = null;

// --- 3. STORAGE ---
const getStorageKey = (type, branch) => `RECON_${type}_${branch}`;
const loadData = (type, branch) => localStorage.getItem(getStorageKey(type, branch));
const saveData = (type, branch, text) => localStorage.setItem(getStorageKey(type, branch), text);

// --- 4. PARSING ---
function parseText(rawText) {
    if (!rawText) return [];
    const rows = [];
    const lines = rawText.split('\n');
    for (let line of lines) {
        if (!line.trim()) continue;
        
        const parts = line.split('|').map(p => p.trim());
        let name = "Unknown";
        let qty = 0;

        // Single Column (Master List) OR Header check
        if (parts.length === 1 && parts[0].length > 0 && !line.includes("Total Item Sales")) {
            name = parts[0];
            qty = 0;
        } else {
            // Multi Column (Sales Data)
            parts.forEach(p => {
                const val = parseInt(p);
                if (!isNaN(val)) { qty = val; }
                else if (p.length > 1 && p !== "HEAD") { name = p; }
            });
        }

        if (name !== "Unknown" && name !== "HEAD") {
            rows.push({ name, qty: isNaN(qty) ? 0 : qty });
        }
    }
    return rows;
}

// --- 5. ROBUST UPLOAD FUNCTION (FIXED FOR USER) ---
async function uploadExcel(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    // UI Feedback
    input.parentElement.style.borderColor = "var(--primary)";
    input.parentElement.style.background = "#eff6ff";
    input.parentElement.querySelector('span:last-child').innerText = "Reading file...";

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Check if there are sheets
            if (workbook.SheetNames.length === 0) {
                alert("Error: Excel file is empty.");
                return;
            }

            const firstSheetName = workbook.SheetNames[0];
            const firstSheet = workbook.Sheets[firstSheetName];
            
            // Try to convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            if (jsonData.length === 0) {
                alert("Error: No data rows found in the first sheet. Please check if Row 1 contains headers.");
                input.parentElement.querySelector('span:last-child').innerText = "Empty File";
                return;
            }

            // --- DEBUGGING: Alert headers ---
            const firstRowKeys = Object.keys(jsonData[0]);
            console.log("Excel Headers Found:", firstRowKeys);
            // alert("Headers found: " + firstRowKeys.join(", ")); // Uncomment to see headers on screen

            const parsed = [];
            jsonData.forEach(row => {
                const keys = Object.keys(row);
                
                // 1. Try Standard Search (Case Insensitive)
                let nameKey = keys.find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('item'));
                let qtyKey = keys.find(k => k.toLowerCase().includes('qty') || k.toLowerCase().includes('quantity') || k.toLowerCase().includes('sold'));

                // 2. FALLBACK: If standard search fails, Guess based on Value Types
                // Assume 1st column is Name, 1st numeric column is Qty
                if (!nameKey) {
                    nameKey = keys[0]; 
                }
                if (!qtyKey) {
                    qtyKey = keys.find(k => typeof row[k] === 'number' && k !== nameKey);
                }

                if (nameKey) {
                    parsed.push({
                        name: row[nameKey],
                        qty: qtyKey ? Number(row[qtyKey]) : 0
                    });
                }
            });

            if (parsed.length === 0) {
                alert("Could not find valid data columns. Please check your headers.");
                input.parentElement.querySelector('span:last-child').innerText = "Error";
                return;
            }

            // Update State and UI
            const textArea = type === 'master' ? document.getElementById('inputMASTER') : (type === 'rest' ? document.getElementById('inputREST' ) : document.getElementById('inputPOS'));
            
            textArea.value = `[Loaded ${parsed.length} items from ${file.name}]`;
            
            if(type === 'master') state.masterData = parsed;
            else if(type === 'rest') state.restData = parsed;
            else if(type === 'pos') state.posData = parsed;
            
            // Trigger Processing
            processData();
            
            // Reset UI Text
            input.parentElement.querySelector('span:last-child').innerText = "File Loaded ‚úÖ";

        } catch (error) {
            console.error(error);
            alert("Error reading Excel file: " + error.message);
            input.parentElement.querySelector('span:last-child').innerText = "Error";
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- 6. CHART UPDATE LOGIC ---
function updateDashboardCharts() {
    if(state.results.length === 0) return;

    // 1. Volume Comparison Chart (Bar)
    const totalRest = parseInt(document.getElementById('kpi-rest').innerText.replace(/,/g, ''));
    const totalPos = parseInt(document.getElementById('kpi-pos').innerText.replace(/,/g, ''));
    
    const ctx1 = document.getElementById('volumeChart').getContext('2d');
    if(volumeChartInstance) volumeChartInstance.destroy();
    
    volumeChartInstance = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: ['REST Stock', 'POS Sales'],
            datasets: [{
                label: 'Volume',
                data: [totalRest, totalPos],
                backgroundColor: ['#2563eb', '#10b981'],
                borderWidth: 1
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
    });

    // 2. Top 10 Variance Chart (Horizontal Bar)
    // Sort by absolute difference
    const topVariances = [...state.results]
        .sort((a, b) => Math.abs(b.d) - Math.abs(a.d))
        .slice(0, 10);

    const ctx2 = document.getElementById('varianceChart').getContext('2d');
    if(varianceChartInstance) varianceChartInstance.destroy();

    varianceChartInstance = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: topVariances.map(r => r.name),
            datasets: [{
                label: 'Variance',
                data: topVariances.map(r => r.d),
                backgroundColor: topVariances.map(r => r.d < 0 ? '#ef4444' : '#f59e0b'),
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: {display:false} }
        }
    });
}

// --- 7. ACTIONS ---

function loadProvidedList() {
    document.getElementById('inputMASTER').value = PROVIDED_MASTER_DATA;
    processData();
    alert("Clean List Loaded Successfully!");
}

function switchBranch() {
    const select = document.getElementById('branchSelect');
    const branch = select.value;
    state.currentBranch = branch;

    if (!branch) return; 

    const savedRest = loadData('REST', branch);
    const savedPos = loadData('POS', branch);
    const savedMaster = loadData('MASTER', branch);

    document.getElementById('inputREST').value = savedRest || "";
    document.getElementById('inputPOS').value = savedPos || "";
    document.getElementById('inputMASTER').value = savedMaster || "";

    if (savedRest || savedPos) {
        state.restData = savedRest ? parseText(savedRest) : [];
        state.posData = savedPos ? parseText(savedPos) : [];
        state.masterData = savedMaster ? parseText(savedMaster) : [];
        processData();
    } else {
        state.restData = [];
        state.posData = [];
        state.masterData = [];
        updateKPIs(0, 0);
        document.getElementById('dataTableBody').innerHTML = "";
    }
    renderMatrix();
}

function addToMatrix() {
    if (!state.currentBranch) { alert("Please select a branch first."); return; }

    const totalItems = state.results.length;
    const totalRest = parseInt(document.getElementById('kpi-rest').innerText.replace(/,/g, ''));
    const totalPos = parseInt(document.getElementById('kpi-pos').innerText.replace(/,/g, ''));
    const diff = totalPos - totalRest;
    const acc = document.getElementById('kpi-acc').innerText;

    const existingIndex = state.matrix.findIndex(m => m.branch === state.currentBranch);
    if (existingIndex > -1) {
        state.matrix[existingIndex] = { branch: state.currentBranch, items: totalItems, rest: totalRest, pos: totalPos, diff, acc };
    } else {
        state.matrix.push({ branch: state.currentBranch, items: totalItems, rest: totalRest, pos: totalPos, diff, acc });
    }
    renderMatrix();
    alert("‚úÖ Saved to Matrix!");
}

function loadFromMatrix(branchName) {
    const select = document.getElementById('branchSelect');
    select.value = branchName;
    switchBranch();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- 8. CORE LOGIC ---

function processData() {
    const masterText = document.getElementById('inputMASTER').value;
    const restText = document.getElementById('inputREST').value;
    const posText = document.getElementById('inputPOS').value;

    if (masterText && !masterText.includes('[Loaded')) state.masterData = parseText(masterText);
    if (restText && !restText.includes('[Loaded')) state.restData = parseText(restText);
    if (posText && !posText.includes('[Loaded')) state.posData = parseText(posText);

    if (state.currentBranch) {
        saveData('REST', state.currentBranch, document.getElementById('inputREST').value);
        saveData('POS', state.currentBranch, document.getElementById('inputPOS').value);
        saveData('MASTER', state.currentBranch, document.getElementById('inputMASTER').value);
    }

    // Normalize Names
    const nameStandardizer = {};
    state.masterData.forEach(item => {
        nameStandardizer[item.name.toLowerCase().trim()] = item.name; 
    });

    function getDisplayName(rawName) {
        const key = rawName.toLowerCase().trim();
        if (nameStandardizer[key]) return nameStandardizer[key];
        if (state.mapping[key]) return state.mapping[key];
        return rawName;
    }

    const merged = {};
    
    state.restData.forEach(r => {
        const displayName = getDisplayName(r.name);
        if (!merged[displayName]) merged[displayName] = { r: 0, p: 0, name: displayName };
        merged[displayName].r += r.qty;
    });

    state.posData.forEach(r => {
        const displayName = getDisplayName(r.name);
        if (!merged[displayName]) merged[displayName] = { r: 0, p: 0, name: displayName };
        merged[displayName].p += r.qty;
    });

    state.results = [];
    let totalRest = 0;
    let totalPos = 0;

    Object.values(merged).forEach(item => {
        const diff = item.p - item.r;
        let varPct = 0;
        if (item.r === 0 && item.p === 0) varPct = 0;
        else if (item.r === 0) varPct = 100;
        else varPct = ((diff / item.r) * 100).toFixed(1);

        totalRest += item.r;
        totalPos += item.p;

        state.results.push({ name: item.name, r: item.r, p: item.p, d: diff, v: varPct });
    });

    state.results.sort((a, b) => Math.abs(b.d) - Math.abs(a.d));

    updateKPIs(totalRest, totalPos);
    renderTable();
    
    // UPDATE CHARTS
    updateDashboardCharts();
}

// --- 9. RENDERERS ---

function updateKPIs(totalRest, totalPos) {
    document.getElementById('kpi-rest').innerText = totalRest.toLocaleString();
    document.getElementById('kpi-pos').innerText = totalPos.toLocaleString();
    
    const netDiff = totalPos - totalRest;
    const diffElem = document.getElementById('kpi-diff');
    diffElem.innerText = (netDiff > 0 ? "+" : "") + netDiff.toLocaleString();
    diffElem.className = "kpi-value " + (netDiff > 0 ? "diff-pos" : (netDiff < 0 ? "diff-neg" : "diff-zero"));

    const accuracy = totalRest === 0 ? 100 : ((1 - Math.abs(netDiff) / totalRest) * 100);
    document.getElementById('kpi-acc').innerText = accuracy.toFixed(1) + "%";
}

function renderMatrix() {
    const tbody = document.getElementById('matrixBody');
    tbody.innerHTML = "";

    state.matrix.forEach((m, index) => {
        const tr = document.createElement('tr');
        tr.className = "matrix-row";
        if(m.branch === state.currentBranch) tr.classList.add('active');
        
        tr.onclick = (e) => {
            if(e.target.tagName === 'BUTTON') return;
            loadFromMatrix(m.branch);
        };

        let diffClass = "diff-zero";
        if (m.diff > 0) diffClass = "diff-pos";
        if (m.diff < 0) diffClass = "diff-neg";

        tr.innerHTML = `
            <td><strong>${m.branch}</strong></td>
            <td>${m.items}</td>
            <td>${m.rest.toLocaleString()}</td>
            <td>${m.pos.toLocaleString()}</td>
            <td class="${diffClass}">${m.diff}</td>
            <td>${m.acc}</td>
            <td><button style="background:#fee2e2; color:#ef4444; border:none; padding:4px 8px; border-radius:4px; font-size:12px; cursor:pointer; font-weight:600;" onclick="removeMatrix(${index})">Remove</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function removeMatrix(index) {
    state.matrix.splice(index, 1);
    renderMatrix();
}

function renderTable() {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = "";
    state.results.forEach((r, index) => {
        let diffClass = "diff-zero";
        if (r.d > 0) diffClass = "diff-pos";
        if (r.d < 0) diffClass = "diff-neg";
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${r.name}</td>
            <td style="text-align:center" contenteditable="true" class="editable-cell" onblur="updateCell(${index}, 'r', this)">${r.r}</td>
            <td style="text-align:center" contenteditable="true" class="editable-cell" onblur="updateCell(${index}, 'p', this)">${r.p}</td>
            <td style="text-align:center" class="${diffClass}">${r.d > 0 ? '+' : ''}${r.d}</td>
            <td style="text-align:center; font-size:12px; color:var(--text-muted)">${r.v}%</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateCell(index, type, element) {
    let newVal = parseInt(element.innerText);
    if (isNaN(newVal)) newVal = 0;
    state.results[index][type] = newVal;
    
    const row = state.results[index];
    row.d = row.p - row.r;
    if (row.r === 0 && row.p === 0) row.v = 0;
    else if (row.r === 0) row.v = 100;
    else row.v = ((row.d / row.r) * 100).toFixed(1);

    const rowNode = element.parentNode;
    rowNode.children[3].innerText = (row.d > 0 ? '+' : '') + row.d;
    rowNode.children[3].className = "text-center " + (row.d > 0 ? "diff-pos" : (row.d < 0 ? "diff-neg" : "diff-zero"));
    rowNode.children[4].innerText = row.v + "%";
    
    let tRest = 0, tPos = 0;
    state.results.forEach(x => { tRest += x.r; tPos += x.p; });
    updateKPIs(tRest, tPos);
    updateDashboardCharts(); // Refresh charts on edit
}

document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toUpperCase();
    const rows = document.getElementById('dataTableBody').getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {
        const td = rows[i].getElementsByTagName('td')[0]; 
        if (td) {
            const txtValue = td.textContent || td.innerText;
            rows[i].style.display = (txtValue.toUpperCase().indexOf(filter) > -1) ? "" : "none";
        }
    }
});

// --- 10. REPORTS ---
function generateReport() {
    if (state.results.length === 0) { alert("No data available."); return; }
    const branch = state.currentBranch || "Unspecified";
    const totalItems = state.results.length;
    const varianceItems = state.results.filter(r => r.d !== 0);
    const varianceCount = varianceItems.length;
    const matchedCount = totalItems - varianceCount;

    document.getElementById('reportMeta').innerText = `Branch: ${branch} | Date: ${new Date().toLocaleDateString()}`;
    document.getElementById('rptVariance').innerText = varianceCount;
    document.getElementById('rptMatched').innerText = matchedCount;

    updateReportTable(varianceItems);
    document.getElementById('reportModal').style.display = 'flex';
}

function updateReportTable(varianceItems) {
    const tbody = document.getElementById('reportTableBody');
    const noMsg = document.getElementById('noVarianceMsg');
    
    tbody.innerHTML = "";
    
    if (varianceItems.length === 0) {
        if(noMsg) noMsg.style.display = 'block';
        return;
    } else {
        if(noMsg) noMsg.style.display = 'none';
    }

    varianceItems.forEach(item => {
        const tr = document.createElement('tr');
        let diffClass = "diff-zero";
        if (item.d > 0) diffClass = "diff-pos";
        if (item.d < 0) diffClass = "diff-neg";

        tr.innerHTML = `
            <td>${item.name}</td>
            <td style="text-align:center">${item.r}</td>
            <td style="text-align:center">${item.p}</td>
            <td style="text-align:center" class="${diffClass}">${item.d > 0 ? '+' : ''}${item.d}</td>
        `;
        tbody.appendChild(tr);
    });
}

function downloadReportCSV() {
    const branch = state.currentBranch || "Unspecified";
    const varianceItems = state.results.filter(r => r.d !== 0);
    
    if (varianceItems.length === 0) { alert("No variances to download!"); return; }

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += `Variance Report - ${branch}\n`;
    csvContent += "Item Name,REST Qty,POS Qty,Difference\n";

    varianceItems.forEach(item => {
        const row = `"${item.name}",${item.r},${item.p},${item.d}`;
        csvContent += row + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Variance_Report_${branch}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function closeReport() {
    document.getElementById('reportModal').style.display = 'none';
}

function copyReport() {
    const branch = state.currentBranch || "Unspecified";
    const varianceItems = state.results.filter(r => r.d !== 0);
    
    let text = `RECONCILIATION REPORT - ${branch}\n`;
    text += `Date: ${new Date().toLocaleDateString()}\n\n`;
    text += `SUMMARY:\n`;
    text += `Variance Count: ${varianceItems.length}\n`;
    text += `Matched Items: ${state.results.length - varianceItems.length}\n\n`;
    
    if (varianceItems.length > 0) {
        text += `VARIANCE DETAILS (Top 20):\n`;
        text += `----------------------------------\n`;
        text += `Item                | REST | POS | Diff\n`;
        varianceItems.slice(0, 20).forEach(r => {
            const name = r.name.substring(0, 18).padEnd(18, ' ');
            text += `${name} | ${r.r.toString().padStart(4)} | ${r.p.toString().padStart(3)} | ${r.d}\n`;
        });
    } else {
        text += `‚úÖ Perfect Match! No variances found.\n`;
    }

    navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
}
</script>

</body>
</html>
